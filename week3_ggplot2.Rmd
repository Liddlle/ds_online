---
title: "Making plots: grammar of graphics and ggplot2 package"
output: 
  learnr::tutorial:
progressive: true
allow_skip: true
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
library(learnr)
library(checkr)
library(tidyverse)
data(mpg)
knitr::opts_chunk$set(exercise.checker = checkr::checkr_tutor, error = TRUE)

tutorial_options(exercise.timelimit = 60)

```


## Библиотека ggplot2

> "In brief, the grammar tells us that a statistical graphic is a mapping from data to aesthetic attributes (colour, shape, size) of geometric objects (points, lines, bars). The plot may also contain statistical transformations of the data and is drawn on a specific coordinate system"

  - Wickham, H. (2009). *ggplot2: elegant graphics for data analysis*. Springer Science & Business Media.
  
Пакет `ggplot2`, написанный Hadley Wickham, является реализацией "Грамматики графики" (Leland Wilkinson)

- Сайт: [ggplot2.org](http://ggplot2.org)
- Документация: [docs.ggplot2.org](http://docs.ggplot2.org/)
- [Шпаргалка](https://www.rstudio.com/wp-content/uploads/2015/03/ggplot2-cheatsheet.pdf)

Определенные типы графиков являются более информативными для определенных типов переменных.

#### *Два основных типа переменных*:
* Категориальные (Categorical)
* Дискретные (Discrete)

#### *Основные типы графиков*:

* Столбчатая диаграмма (Barplot)
* "Ящик с усами" (Boxplot)
* Гистограмма (Histogram)
* Диаграмма рассеяния (Scatterplot)

Некоторые типы графиков могут быть построены по одной переменной, представленной в базе данных, в то время, как другие требуют использования двух переменных по обеим осям. 

В целом, основные типы графиков можно разбить на следующие категории:

**Одна непрерывная переменная**

  + Гистограмма (Histogram)
  
  
**Одна дискретная переменная** 

  + Столбчатая диаграмма (Barplot)
  
**Дискретная переменная по оси X, непрерывная переменная по оси Y**

  + "Ящик с усами" (Boxplot)
  
**Непрерывная переменная по оси X, непрерывная переменная по оси Y**

  + Диаграмма рассеяния (Scatterplot)
  
**Основные компоненты графиков из пакета ggplot2**:

- **data frame** = источник данных
- **aesthetic mappings** = как данным сопоставляется цвет / размер / положение (x vs y)  и т.д.
- **geoms** = геометрические объекты (точки, линии, формы) 
- **facets** = графики с условиями (разделениями по классам, например) 
- **stats** = статистические преобразования (сглаживание, разделение на промежутки и т.д.) 
- **scales** = описание шкал (например, male = red, female = blue)
- **coordinate system** = система координат, в которой строится график
- **positions** = определяют, как расположить геометрические объекты на графике

Больше различных функций для добавления новых слоев и элементов на график можно найти на [сайте с документацией пакета ggplot2](http://ggplot2.tidyverse.org/reference/)

Различные спецификации деталей аестетик (цвет, тип линии, форма) можно также найти на [сайте с документацией ggplot2](http://ggplot2.tidyverse.org/articles/ggplot2-specs.html#sec:line-type-spec)

Любой график строится слоями, каждый новый слой или элемент добавляется при помощи логического опрератора "+":

- `g <- ggplot(data, aes(variable1, variable2))` = создание объекта, соответствующего графику, и указание используемого датасета
    + `aes(x = variable1, y = variable2)` = описание эстетик (в данном случае -- какую переменную мы берем за x, а какую -- за y)
    + `geom_point()` = построение точечного графика на основе указанной ранее информации
    + `theme_bw()` = добавление дополнительного элемента, задающего общую тему для всего графика
    
Перед началом построения графиков загрузим библиотеку ggplot2, а также базу данных, содержащую наблюдения для 38 моделей автомобилей.

```{r ex1, exercise = TRUE}
library(ggplot2)
data(mpg)
head(mpg, n = 3) #смотрим на первые три наблюдения, представленные в базе данных
```

```{r echo=F}
help(mpg) #получаем дополнительную информацию по базе данных
```

##Гистограмма

Данный тип графика полезен для того, чтобы узнать больше деталей касательно распределения имеющихся данных.

Сколько миль проедут автомобили по городу на одном галлоне топлива? (Используем для этого непрерывную переменную `cty` из базы данных `mpg`)

```{r ex2, exercise = TRUE}
class(mpg$cty) #проверяем класс переменной
#данная переменная является числовой, поэтому можно использовать ее для построения гистограммы
```

*Строим стандартную гистограмму, добавляя к функции системы координат `ggplot()` слой с гистограммой `geom_histogram`.*

```{r ex3, exercise = TRUE}
ggplot() +
  geom_histogram(data = mpg, mapping = aes(x = cty))
```

Важным шагом при построении графика является добавление названий осей, а также самого графика. Для добавления данных элементов необходимо использовать функции `xlab` для подписи оси X, `ylab` для подписи оси Y, `ggtitle` для добавления названия графика через оператор `+`. Для того, чтобы вместить длинное название для графика, можно использовать `\n` для переноса текста на следующую строку.

```{r ex4, exercise = TRUE}
ggplot() +
  geom_histogram(data = mpg, aes(x = cty)) + 
  ggtitle("Распределение количества миль на один галон топлива\nв условиях города") + 
  xlab("Мили") + 
  ylab("Количество")
```

Так как на графике видно довольно много пробелов по оси X, стоит добавить аргумент `binwidth` в слой с гистограммой, чтобы увеличить интервалы для каждого столбца гистограммы. В данном случае будем использовать значение 1.

```{r ex5, exercise = TRUE}
ggplot() +
  geom_histogram(data = mpg, aes(x = cty), binwidth = 1) + 
  ggtitle("Распределение количества миль на один галон топлива\nв условиях города") + 
  xlab("Мили") + 
  ylab("Количество")
```

График стал более плотным. 

Теперь попробуем изменить цвет самой гистограммы. Для этого после функции с указанием аэстетик добавляем аргумент `fill`, который позволяет заполнить цветом всю гистограмму. Для изменения цвета границ гистограммы необходимо также прописать аргумент `col`. Для изменения уровня прозрачности используемого для заливки цвета необходимо использовать аргумент `alpha`. 

```{r ex6, exercise = TRUE}
ggplot() +
  geom_histogram(data = mpg, aes(x = cty), binwidth = 1, fill="#008080", col="#483D8B", alpha = 0.5)  + 
  ggtitle("Распределение количества миль на один галон топлива\nв условиях города") + 
  xlab("Мили") + 
  ylab("Количество")
```

Теперь добавим линию, отражающую среднее значение, при помощи дополнительного слоя `geom_vline()`. Мы можем также менять тип, цвет и ширину линии. Для этого, после установления отображаемой аэстетики, которая выражена средним сначением миль с использованием одного галона топлива, указываем следующие переменные: *linetype*, *color*, *size*.

```{r ex7, exercise = TRUE}
ggplot() +
  geom_histogram(data = mpg, aes(x = cty), binwidth = 1, fill="#008080", col="#483D8B", alpha = 0.5)  + 
  ggtitle("Распределение количества миль на один галон топлива\nв условиях города") + 
  xlab("Мили") + 
  ylab("Количество") +
  geom_vline(aes(xintercept = mean(mpg$cty)), linetype="dashed", color="#8B0000", size=1) 
```

Теперь добавим элемент, который будет определять общий стиль графика, при помощи функции `theme_bw()`.

```{r ex8, exercise = TRUE}
ggplot() +
  geom_histogram(data = mpg, aes(x = cty), binwidth = 1, fill="#008080", col="#483D8B", alpha = 0.5)  + 
  ggtitle("Распределение количества миль на один галон топлива\nв условиях города") + 
  xlab("Мили") + 
  ylab("Количество") +
  geom_vline(aes(xintercept = mean(mpg$cty)), linetype="dashed", color="#8B0000", size=1) + 
  theme_bw()
```

### Упражнения

1. Добавьте к существующему графику линию медианы. (Функция `median`)

```{r new1, exercise = TRUE}
ggplot() +
  geom_histogram(data = mpg, aes(x = cty), binwidth = 1, fill="#008080", col="#483D8B", alpha = 0.5)  + 
  ggtitle("Распределение количества миль на один галон топлива\nв условиях города") + 
  xlab("Мили") + 
  ylab("Количество") +
  geom_vline(aes(xintercept = mean(mpg$cty)), linetype="dashed", color="#8B0000", size=1) +
  theme_bw() +
  #добавьте медиану

```

```{r new1-check, echo=FALSE}
test_1 <- find_value(match_class("ggplot"))

USER_CODE %>% test_1 %>% find_call("median(whatever)", "you didn't use median().") 
```


```{r echo=F, eval=F}
#ответ
ggplot() +
  geom_histogram(data = mpg, aes(x = cty), binwidth = 1, fill="#008080", col="#483D8B", alpha = 0.5)  + 
  ggtitle("Распределение количества миль на один галон топлива\nв условиях города") + 
  xlab("Мили") + 
  ylab("Количество") +
  geom_vline(aes(xintercept = mean(mpg$cty)), linetype="dashed", color="#8B0000", size=1) +
  geom_vline(aes(xintercept = median(mpg$cty))) + 
  theme_bw()
```

2. Исходя из графика, какое значение больше? Среднее значение или значение медианы?

```{r new3, exercise = TRUE}


```

3. Постройте гистограмму по количеству миль на галон в условиях шоссе (переменная `hwy`)

```{r new2, exercise = TRUE}
ggplot() + ...
```

```{r new2-check, echo=FALSE}
USER_CODE %>% find_value(match_class("ggplot")) %>% 
  find_call("geom_histogram(whatever)", "you didn't use geom_histogram().") %>% 
  find_call("aes(whatever)", "you didn't use aesthetics.") %>% 
  find_names("hwy") %>% find_names("mpg")
```

```{r echo=F, eval=F}
ggplot() +
  geom_histogram(data = mpg, aes(x = hwy))
```

4. Опишите разницу между двумя гистограммами. Какое количество миль чаще проезжают автомобили в условиях города и шоссе?


```{r new4, exercise = TRUE}

```
```{r echo=F, eval=F}
#Ответ: на шоссе автомобили чще ппроезжают более дальние расстояния. Большинство автомобилей способны проехать на одном галоне топлива около 27 миль по шоссе в то время, как  городе эта цифра чаще равна примерно 20.

```


5. Добавьте к получившимуся графику линии моды, медианы, а также среднего. Измените внешний вид полученного графика, используя известные вам аргументы функций. Можно ли назвать полученное распределение нормальным? Почему?

*В R нет отдельной функции для отображения моды, поэтому необходимо воспользоваться кодом для ее написания, представленном ниже*

```{r}
Mode <- function(x) {
ux <- unique(x)
ux[which.max(tabulate(match(x, ux)))]
}
```


```{r new5, exercise = TRUE}
ggplot() + ...
```

```{r new5-check, echo=FALSE}
USER_CODE %>% find_value(match_class("ggplot")) %>% 
  find_call("geom_histogram(whatever)", "you didn't use geom_histogram().") %>% 
  find_call("aes(whatever)", "you didn't use aesthetics.") %>% 
  find_names("hwy") %>% find_names("mpg")
#Полученное расспределение нельзя назвать нормальным, так как мода, медиана и среднее не совпадают. Большая часть машин проезжает около 27 миль с учетом одного галона топлива в условиях шоссе. При этом очень саленькое количество автомобилей проезжаетт больше 30 миль на галон.
```

```{r echo=F, eval=F}
ggplot() +
  geom_histogram(data = mpg, aes(x = hwy), binwidth = 1, fill="#6495ED", col="#00008B", alpha = 0.5)  + 
  ggtitle("Распределение количества миль на один галон топлив\nв условиях шоссе") + 
  xlab("Мили") + 
  ylab("Количество") +
  geom_vline(aes(xintercept = mean(mpg$hwy)), linetype="dashed", color="#8B0000", size=1) +
  geom_vline(aes(xintercept = median(mpg$hwy)), linetype="dotted", color="#8B0000", size=1) + 
  geom_vline(aes(xintercept = median(mpg$hwy)), linetype="solid", color="#A9A9A9", size=1) + 
  theme_bw()
```

##Столбчатая диаграмма

Такой тип графика используется в основном для отображения количественных характеристик категориальной переменной. По умолчанию можно построить график на основе лишь одной категориальной переменной, для каждого элемента которой будет посчитано количество, в котором он встречается в базе данных.

Какой класс автомобилей встречается в базе данных чаще всего?

```{r new6, exercise = TRUE}
ggplot() +
  geom_bar(data = mpg, aes(x = class))
```

Из графика видно, что наиболее частым классом автомобилей является `suv`.

Теперь добавим подписи к осям и название графика, а также посмотрим на то, как распределены классы для автомобилей, использующих разные типы привода Для этого будем использовать аргумент `fill` в функции для отображения аестетик.

```{r new7, exercise = TRUE}
ggplot() +
  geom_bar(data = mpg, aes(x = class, fill=drv)) +
  xlab("Класс автомобиля") +
  ylab("Количество") +
  ggtitle("Количество классов автомобилей\nдля различных групп привода")
```

Теперь обозначим аргумент `position` для того, чтобы расположить каждую группу рассматриваемых приводов в отдельном столбце. 

```{r new8, exercise = TRUE}
ggplot() +
  geom_bar(data = mpg, aes(x = class, fill=drv), position = "dodge") +
  xlab("Класс автомобиля") +
  ylab("Количество") +
  ggtitle("Количество классов автомобилей\nдля различных групп привода")
```

Поменяем палитру используемых цветов в функции `scale_fill_brewer()`, а также изменим название параметра, указанного в легенде при помощи аргумента `name`. Изменим также тему графика. Подробнее о существующих палетках можно узнать в [документации](http://www.cse.unsw.edu.au/~mike/myrlibrary.old/RColorBrewer/html/ColorBrewer.html)

```{r new9, exercise = TRUE}
ggplot() +
  geom_bar(data = mpg, aes(x = class, fill=drv), position = "dodge") +
  xlab("Класс автомобиля") +
  ylab("Количество") +
  ggtitle("Количество классов автомобилей\nдля различных типов привода") +
  scale_fill_brewer(name = "Тип\nпривода", palette = "Set2") +
  theme_bw()
```

Если мы все же хотим добавить какой-либо численный параметр из базы данных на ось Y, то мы можем использовать аргумент `stat = "identity"`. Например, необходимо узнать, какой класс автомобилей проезжает наибольшее количество миль на галон в городе. Здесь мы также  можем присвоить им какой-либо цвет столбцам.

```{r new10, exercise = TRUE}
ggplot() +
  geom_bar(data = mpg, aes(x = class, y = cty), stat = "identity", fill = "#9400D3", alpha = 0.5) +
  xlab("Класс автомобиля") +
  ylab("Мили на галон") +
  ggtitle("Количество миль на галон в городе\nдля различных классов автомобилей") + 
  theme_bw()
```

Так, наибольшее количество миль на гало в условиях города проезжают компактные автомобили.

### Упражнения

1. Постройте столбчатую диаграмму, в которой ось X будет отражать тип топлива, а ось Y - количество миль на галон на шоссе. Получившийся график запишите в переменную `g`.

Ответ:

```{r new11, exercise = TRUE}
ggplot() + ...
```

```{r new11-check, echo=FALSE}
USER_CODE %>% find_value(match_class("ggplot")) %>% 
  find_call("geom_histogram(whatever)", "you didn't use geom_histogram().") %>% 
  find_call("aes(whatever)", "you didn't use aesthetics.") %>% 
  find_names("hwy") %>% find_names("mpg")
```

```{r echo=F, eval=F}

g <- ggplot() +
  geom_bar(data = mpg, aes(x = fl, y = hwy), stat = "identity")
```



2. Постройте столбчатую диаграмму, показывающую расход топлива в городе для различных классов машин с разными потребляемыми типами топлива. Опишите получившийся график.

```{r new12, exercise = TRUE}
ggplot() + ...
```

```{r new12-check, echo=FALSE}
USER_CODE %>% find_value(match_class("ggplot")) %>% 
  find_call("geom_histogram(whatever)", "you didn't use geom_histogram().") %>% 
  find_call("aes(whatever)", "you didn't use aesthetics.") %>% 
  find_names("hwy") %>% find_names("mpg")
```

```{r echo=F, eval=F}
ggplot() +
  geom_bar(data = mpg, aes(x = class, y=cty, fill=fl), position = "dodge", stat = "identity") +
  xlab("Класс автомобиля") +
  ylab("Миль на галон") +
  ggtitle("Расход топлива в городе\nдля различных классов машин\nс разными потребляемыми типами топлива") +
  scale_fill_brewer(name = "Тип\nтоплива", palette = "Dark2") +
  theme_bw()
```


